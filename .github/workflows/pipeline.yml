name: Agora Daily Pipeline

# --- è§¦å‘å™¨ ---
on:
  # 1. å…è®¸ä½ æ‰‹åŠ¨ç‚¹å‡» "Run workflow" æ¥è¿è¡Œ
  workflow_dispatch:
  
  # 2. å®šæ—¶ä»»åŠ¡ (Cron Job)
  # è¿™æ˜¯ä¸€ä¸ª cron è¡¨è¾¾å¼ï¼Œè¡¨ç¤ºåœ¨æ¯å¤©çš„ 00:00 UTC (åŒ—äº¬æ—¶é—´ æ—©ä¸Š8ç‚¹) è¿è¡Œ
  schedule:
    - cron: '0 0 * * *'

# --- æƒé™ ---
# å…è®¸è¿™ä¸ª Action è¯» (checkout) å’Œ å†™ (push) ä½ çš„ä»“åº“
permissions:
  contents: write

# --- ä»»åŠ¡ ---
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ç­¾å‡º (Checkout) ä½ çš„ä»£ç 
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. è®¾ç½® Python 3.10 ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3. å®‰è£…ä¾èµ–åº“
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      # 4. åˆ›å»º .env æ–‡ä»¶
      # ä» GitHub Secrets è¯»å–å¯†é’¥å¹¶å†™å…¥åˆ° .env æ–‡ä»¶ä¸­
      - name: Create .env file
        run: |
          echo "AI_API_KEY=${{ secrets.AI_API_KEY }}" >> .env
          echo "AI_BASE_URL=${{ secrets.AI_BASE_URL }}" >> .env

      # 5. è¿è¡Œå®Œæ•´çš„æœ¬åœ°æµæ°´çº¿ [cite: 14, 39]
      - name: Run Python Pipeline
        run: |
          chmod +x ./pipeline.sh
          ./pipeline.sh

      # 6. å¤åˆ¶å¹¶é‡å‘½åæœ€ç»ˆæŠ¥å‘Š [cite: 40]
      # æ‰¾åˆ°æœ€æ–°çš„ ranked.json æ–‡ä»¶ï¼Œå¹¶å°†å…¶å¤åˆ¶åˆ°æ ¹ç›®å½•ï¼Œå‘½åä¸º latest_data.json
      - name: Copy latest data
        run: |
          LATEST_RANKED_FILE=$(find data/ranked -name "*-ranked.json" -print0 | xargs -0 ls -t | head -n 1)
          if [ -z "$LATEST_RANKED_FILE" ]; then
            echo "âŒ Error: No ranked file found."
            exit 1
          fi
          echo "Copying $LATEST_RANKED_FILE to latest_data.json"
          cp "$LATEST_RANKED_FILE" ./latest_data.json

      # 7. æäº¤å¹¶æ¨é€æ•°æ®æ–‡ä»¶ [cite: 41]
      - name: Commit and Push latest_data.json
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "action-bot@github.com"
          git add latest_data.json
          # åªæœ‰åœ¨æ–‡ä»¶æœ‰å˜åŠ¨æ—¶æ‰æäº¤
          git diff --staged --quiet || git commit -m "ğŸ“ˆ [Auto] Update latest scientific data"
          git push