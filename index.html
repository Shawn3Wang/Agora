<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agora | 生命科学每日研究进展导读</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                    colors: {
                        bg: '#0B0F19',       // 极深蓝背景
                        surface: '#111827',  // 卡片背景
                        border: '#1F2937',   // 边框颜色
                        primary: '#3B82F6',  // 科技蓝
                        accent: '#06B6D4',   // 赛博青
                        text: '#F3F4F6',     // 主文本
                        dim: '#9CA3AF',      // 辅助文本
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* (No change to styles) */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0B0F19; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #4B5563; }
        * { -webkit-tap-highlight-color: transparent; }
    </style>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

</head>
<body class="bg-bg text-text h-screen w-screen overflow-hidden flex flex-col md:flex-row">

    <aside class="hidden md:flex flex-col w-72 bg-surface border-r border-border h-full flex-shrink-0 z-20">
        <div onclick="renderHomePage()" class="h-16 flex items-center px-6 border-b border-border cursor-pointer group">
            <div class="flex items-center gap-2 text-primary transition-all group-hover:brightness-110">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                <span class="text-xl font-bold tracking-tight">AGORA</span>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto py-4 px-3">
            <div class="text-xs font-mono text-dim uppercase tracking-wider mb-2 px-3">Channels</div>
            <ul id="desktop-nav-list" class="space-y-1">
                <li class="animate-pulse px-3 py-2 text-sm text-dim">Loading data...</li>
            </ul>
        </div>
        <div class="p-4 border-t border-border text-xs text-dim text-center font-mono">
            v2.8 (Firebase Edition)
        </div>
    </aside>

    <header class="md:hidden flex items-center justify-between h-16 px-4 bg-surface border-b border-border flex-shrink-0 z-20">
        <div onclick="renderHomePage()" class="flex items-center gap-2 text-primary cursor-pointer">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
            <span class="text-lg font-bold">AGORA</span>
        </div>
        <div class="relative">
            <select id="mobile-label-select" class="appearance-none bg-bg border border-border text-white text-sm rounded-lg pl-3 pr-8 py-2 focus:ring-1 focus:ring-primary focus:outline-none">
                <option>Loading...</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-dim">
                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
            </div>
        </div>
    </header>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
        <div class="flex-shrink-0 px-5 py-6 md:px-8 md:py-8 border-b border-border bg-bg/95 backdrop-blur sticky top-0 z-10">
            <div class="flex items-baseline justify-between">
                <h1 id="page-title" class="text-2xl md:text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400">
                    Loading...
                </h1>
            </div>
            <p id="page-subtitle" class="text-dim text-sm mt-1 font-mono">Loading date...</p>
        </div>
        
        <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth pb-32">
            <div class="text-center py-20 text-dim animate-pulse">
                <p class="text-lg">正在连接云端数据库...</p>
                <p class="text-sm mt-2 font-mono text-gray-600">Connecting to Firebase/Firestore</p>
            </div>
        </div>

    </main>

    <script>
        // 全局状态 (No change)
        let ALL_DATA = {};
        let ALL_LABELS = [];
        let LATEST_DATE = new Date().toISOString().split('T')[0]; // 默认日期

        // --- *** NEW: STEP 2 - FIREBASE INITIALIZATION *** ---
        // Your public config keys
        const firebaseConfig = {
          apiKey: "AIzaSyDABSKR7EM1psGewADHAUZ_IjLBZz4bGis",
          authDomain: "agora-sci-news.firebaseapp.com",
          projectId: "agora-sci-news",
          storageBucket: "agora-sci-news.firebasestorage.app",
          messagingSenderId: "321550815715",
          appId: "1:321550815715:web:de8e34c63da76aca4850d6"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        // Get a reference to the Firestore database
        const db = firebase.firestore();

        // --- *** NEW: STEP 3 - REWRITTEN DATA FETCHER *** ---
        async function fetchData() {
            try {
                console.log("Connecting to Firestore...");
                
                // 1. Get the 'latest' pointer (This knows the ID of the newest report)
                // This asks for the document 'latest' from the collection 'metadata'
                const metaRef = await db.collection("metadata").doc("latest").get();
                
                if (!metaRef.exists) {
                    throw new Error("Metadata pointer (metadata/latest) not found.");
                }
                
                const latestReportId = metaRef.data().latest_report_id;
                console.log("Latest report ID is:", latestReportId);

                // 2. Now, get the actual report data using the ID from step 1
                // This asks for the document (e.g., '2025-11-13') from 'daily_reports'
                const reportRef = await db.collection("daily_reports").doc(latestReportId).get();

                if (!reportRef.exists) {
                    throw new Error(`Report document (${latestReportId}) not found.`);
                }
                
                // The data is here! This is the equivalent of the old JSON file.
                ALL_DATA = reportRef.data();
                ALL_LABELS = Object.keys(ALL_DATA).sort(); 
                
                // Set the global date (same logic as before)
                LATEST_DATE = latestReportId; // The ID is the date!
                
                console.log("Data loaded successfully.", ALL_DATA);
                initApp();

            } catch (error) {
                console.error("数据加载失败 (Firebase):", error);
                document.getElementById('content-area').innerHTML = `
                    <div class="text-center py-20">
                        <div class="inline-block p-4 rounded-full bg-red-500/10 text-red-500 mb-4">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        </div>
                        <h2 class="text-xl font-bold text-white">数据加载失败</h2>
                        <p class="text-dim mt-2">无法从 Firebase/Firestore 读取数据。</p>
                        <p class="text-xs text-gray-600 mt-4 font-mono">${error.message}</p>
                        <p class="text-xs text-gray-600 mt-2 font-mono">请检查 Firebase 控制台的 "Rules" 和 "CORS" 设置。</p>
                    </div>
                `;
            }
        }

        // --- ALL FUNCTIONS BELOW THIS LINE ARE UNCHANGED ---
        // They just work, because they depend on the global 'ALL_DATA'
        // variable, which we now populate from Firebase.

        // 2. 渲染导航栏 (Desktop + Mobile)
        function renderNavigation() {
            const desktopList = document.getElementById('desktop-nav-list');
            const mobileSelect = document.getElementById('mobile-label-select');
            
            desktopList.innerHTML = '';
            mobileSelect.innerHTML = '';

            const homeOption = document.createElement('option');
            homeOption.value = "__HOME__";
            homeOption.text = "返回首页 (All Channels)";
            mobileSelect.appendChild(homeOption);

            ALL_LABELS.forEach((label) => {
                const li = document.createElement('li');
                li.className = `px-3 py-2 rounded-md cursor-pointer text-sm font-medium transition-all duration-200 group flex items-center justify-between text-dim hover:bg-white/5 hover:text-white`;
                li.innerHTML = `
                    <span>${label}</span>
                    <span class="text-xs opacity-0 group-hover:opacity-100 transition-opacity text-gray-500 font-mono">→</span>
                `;
                li.onclick = () => switchTab(label, li);
                desktopList.appendChild(li);

                const option = document.createElement('option');
                option.value = label;
                option.text = label;
                mobileSelect.appendChild(option);
            });

            mobileSelect.onchange = (e) => {
                if (e.target.value === "__HOME__") {
                    renderHomePage();
                } else {
                    switchTab(e.target.value);
                }
            };
        }

        // 3. 切换标签页逻辑
        function switchTab(label, activeLi = null) {
            const listItems = document.getElementById('desktop-nav-list').children;
            Array.from(listItems).forEach(li => {
                if (li.textContent.trim().startsWith(label)) {
                    li.className = 'px-3 py-2 rounded-md cursor-pointer text-sm font-medium transition-all duration-200 group flex items-center justify-between bg-primary/10 text-primary border border-primary/20 shadow-glow';
                } else {
                    li.className = 'px-3 py-2 rounded-md cursor-pointer text-sm font-medium transition-all duration-200 group flex items-center justify-between text-dim hover:bg-white/5 hover:text-white';
                }
            });

            document.getElementById('mobile-label-select').value = label;
            renderContent(label);
        }

        // 4. 清除导航高亮
        function clearActiveNav() {
            const listItems = document.getElementById('desktop-nav-list').children;
            Array.from(listItems).forEach(li => {
                li.className = 'px-3 py-2 rounded-md cursor-pointer text-sm font-medium transition-all duration-200 group flex items-center justify-between text-dim hover:bg-white/5 hover:text-white';
            });
            document.getElementById('mobile-label-select').value = "__HOME__";
        }

        // 5. 渲染首页
        function renderHomePage() {
            const contentArea = document.getElementById('content-area');
            const pageTitle = document.getElementById('page-title');
            const pageSubtitle = document.getElementById('page-subtitle');

            pageTitle.textContent = "Agora Daily";
            pageSubtitle.textContent = `Agora: 生命科学每日研究进展导读 ｜ ${LATEST_DATE}`;
            
            clearActiveNav();
            contentArea.innerHTML = ''; 

            const homeWrapper = document.createElement('div');
            homeWrapper.className = 'animate-fade-in';
            homeWrapper.innerHTML = `
                <h2 class="text-lg font-semibold text-white mb-4">所有频道 (All Channels)</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 gap-4">
                </div>
            `;
            
            const grid = homeWrapper.querySelector('.grid');
            
            ALL_LABELS.forEach((label) => {
                const card = document.createElement('div');
                card.className = 'bg-surface border border-border rounded-lg p-4 cursor-pointer hover:border-primary hover:bg-primary/10 transition-all duration-200';
                card.innerHTML = `
                    <h3 class="font-semibold text-white">${label}</h3>
                    <p class="text-xs text-dim mt-1 font-mono">${ALL_DATA[label].length} updates</p>
                `;
                card.onclick = () => switchTab(label);
                grid.appendChild(card);
            });

            contentArea.appendChild(homeWrapper);
        }

        // 6. 渲染文章内容 (核心渲染器)
        function renderContent(label) {
            const articles = ALL_DATA[label] || [];
            const contentArea = document.getElementById('content-area');
            const pageTitle = document.getElementById('page-title');
            const pageSubtitle = document.getElementById('page-subtitle'); 

            pageTitle.textContent = label;
            pageSubtitle.textContent = `Agora: 生命科学每日研究进展导读 ｜ ${LATEST_DATE}`;
            contentArea.innerHTML = '';

            if (articles.length === 0) {
                contentArea.innerHTML = `<div class="text-center text-dim py-10">今日暂无该领域更新</div>`;
                return;
            }

            articles.forEach((article, index) => {
                const delay = index * 50; 
                const card = document.createElement('div');
                card.className = 'bg-surface border border-border rounded-xl p-5 md:p-6 hover:border-primary/30 transition-all duration-300 group animate-fade-in relative overflow-hidden';
                card.style.animationDelay = `${delay}ms`;
                
                card.innerHTML = `
                    <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-primary to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xs font-mono text-accent bg-accent/10 px-2 py-0.5 rounded border border-accent/20">
                            ${article.journal} | ${article.published_display}
                        </span>
                    </div>

                    <h2 class="text-lg md:text-xl font-bold text-white mb-1 group-hover:text-primary transition-colors leading-snug">
                        ${article.title}
                    </h2>
                    ${article.title_cn ? `<h3 class="text-sm text-dim mb-3 font-light line-clamp-1">${article.title_cn}</h3>` : ''}

                    <div class="text-xs text-gray-500 mb-4 font-mono flex items-center gap-2">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        ${article.authors_short || 'Unknown Authors'}
                    </div>

                    <div class="bg-bg/50 rounded-lg p-3 mb-4 border border-white/5">
                        <p class="text-sm text-gray-300 leading-relaxed text-justify">
                            ${article.abstract_cn || article.abstract || 'No abstract available.'}
                        </p>
                    </div>

                    <div class="flex items-center justify-between mt-auto pt-2 border-t border-white/5">
                        <div class="flex gap-2">
                            ${'' /* (Labels removed) */}
                        </div>
                        <a href="${article.link}" target="_blank" class="flex items-center gap-1 text-sm font-medium text-primary hover:text-white transition-colors">
                            Read Paper 
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        </a>
                    </div>
                `;
                contentArea.appendChild(card);
            });
        }

        // 7. 启动 App
        function initApp() {
            renderNavigation();
            renderHomePage();
        }

        // 启动 (We now use the new Firebase-aware fetchData)
        document.addEventListener('DOMContentLoaded', fetchData);

    </script>
</body>
</html>